name: Auto-approve PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write
    
    steps:
      - name: Check if PR should be auto-approved
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // Check if PR is from dependabot or copilot
            const isTrustedBot = pr.user.login.includes('dependabot') || 
                                 pr.user.login.includes('copilot') ||
                                 pr.user.login.includes('github-actions');
            
            // Check if PR has auto-approve label
            const hasAutoApproveLabel = pr.labels.some(label => 
              label.name === 'auto-approve' || 
              label.name === 'auto-merge' ||
              label.name === 'dependencies'
            );
            
            // Check if PR title indicates it's safe to auto-approve
            const isSafeTitle = pr.title.match(/^(chore|deps|fix|test|docs):/i) ||
                               pr.title.includes('dependencies') ||
                               pr.title.includes('dependency');
            
            console.log({
              user: pr.user.login,
              isTrustedBot,
              hasAutoApproveLabel,
              isSafeTitle,
              title: pr.title
            });
            
            return { shouldApprove: isTrustedBot || hasAutoApproveLabel || isSafeTitle };
      
      - name: Auto-approve PR
        if: fromJSON(steps.check.outputs.result).shouldApprove
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            try {
              // Check if already approved by this workflow
              const { data: reviews } = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });
              
              const alreadyApproved = reviews.some(review => 
                review.user.login === 'github-actions[bot]' && 
                review.state === 'APPROVED'
              );
              
              if (alreadyApproved) {
                console.log('PR already approved by this workflow');
                return;
              }
              
              // Approve the PR
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                event: 'APPROVE',
                body: '✅ Auto-approved by GitHub Actions workflow.\n\nThis PR meets the criteria for automatic approval.'
              });
              
              console.log(`✅ Successfully approved PR #${pr.number}`);
              
              // Add auto-merge label if not present
              const hasAutoMergeLabel = pr.labels.some(label => label.name === 'auto-merge');
              if (!hasAutoMergeLabel) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  labels: ['auto-merge']
                });
                console.log('Added auto-merge label');
              }
            } catch (error) {
              console.error(`❌ Failed to approve PR #${pr.number}:`, error.message);
            }
